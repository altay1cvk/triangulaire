<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëë ULTIMATE PRO SYSTEM | GitHub Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@600;700&family=Roboto+Mono:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00ff88;
            --secondary: #00d4ff;
            --accent: #ff0080;
            --warning: #ffaa00;
            --purple: #8844ff;
            --gold: #ffd700;
            --dark: #000;
            --card: #0a0a0a;
            --border: #1a1a1a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 2600px;
            margin: 0 auto;
            padding: 15px;
        }

        .header {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(136,68,255,0.2), rgba(0,255,136,0.2));
            border: 4px solid var(--gold);
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 0 120px rgba(255,215,0,0.8);
            animation: header-glow 4s ease-in-out infinite;
        }

        @keyframes header-glow {
            0%, 100% { box-shadow: 0 0 100px rgba(255,215,0,0.8); }
            50% { box-shadow: 0 0 160px rgba(255,215,0,1); }
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 4.5rem;
            background: linear-gradient(90deg, var(--gold), var(--primary), var(--secondary), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            animation: gradient-flow 5s ease infinite;
            background-size: 300% 100%;
        }

        @keyframes gradient-flow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .btn-control {
            padding: 15px 40px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 900;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-start {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #000;
            box-shadow: 0 0 30px rgba(0,255,136,0.5);
        }

        .btn-start:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px rgba(0,255,136,0.9);
        }

        .btn-start:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-stop {
            background: linear-gradient(135deg, var(--accent), #ff3333);
            color: #fff;
            box-shadow: 0 0 30px rgba(255,0,128,0.5);
        }

        .btn-stop:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px rgba(255,0,128,0.9);
        }

        .btn-stop:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status-indicator {
            display: inline-block;
            padding: 10px 25px;
            border-radius: 15px;
            font-weight: 700;
            margin: 10px 0;
        }

        .status-indicator.running {
            background: rgba(0,255,136,0.2);
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .status-indicator.stopped {
            background: rgba(255,0,128,0.2);
            border: 2px solid var(--accent);
            color: var(--accent);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .feature-badge {
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--gold), var(--warning));
            color: #000;
            border-radius: 15px;
            font-weight: 900;
            font-size: 0.85rem;
            text-align: center;
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr 420px;
            gap: 15px;
        }

        .left-panel, .center-panel, .right-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 15px;
            padding: 20px;
        }

        .card h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .progress-card {
            border: 3px solid var(--gold);
            box-shadow: 0 0 50px rgba(255,215,0,0.4);
        }

        .progress-card h3 {
            color: var(--gold);
        }

        .capital-display {
            text-align: center;
            margin-bottom: 15px;
        }

        .capital-display .value {
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 0 30px rgba(255,215,0,0.8);
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--primary), var(--secondary));
            transition: width 1s ease;
            background-size: 300% 100%;
            animation: shine 3s linear infinite;
        }

        @keyframes shine {
            0% { background-position: -300% 0; }
            100% { background-position: 300% 0; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .stat-box {
            background: rgba(0,0,0,0.6);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .stat-box .label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 6px;
        }

        .stat-box .value {
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            color: var(--gold);
            font-size: 1.1rem;
        }

        .console-card {
            height: 300px;
        }

        .console {
            height: calc(100% - 50px);
            background: #000;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.7rem;
        }

        .log {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .log .time { color: #666; }
        .log.info { color: var(--secondary); }
        .log.success { color: var(--primary); }
        .log.warning { color: var(--warning); }
        .log.error { color: var(--accent); }
        .log.telegram { 
            color: var(--secondary);
            font-weight: 700;
            background: rgba(0,212,255,0.15);
            padding: 4px;
            border-radius: 3px;
        }

        .signals-card {
            border: 3px solid var(--gold);
            box-shadow: 0 0 50px rgba(255,215,0,0.4);
        }

        .signals-card h3 {
            color: var(--gold);
            font-size: 1.4rem;
        }

        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 15px;
            max-height: 550px;
            overflow-y: auto;
        }

        .signal-card {
            background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(136,68,255,0.1));
            border: 3px solid var(--gold);
            border-radius: 15px;
            padding: 20px;
            position: relative;
        }

        .signal-card.elite::before {
            content: 'üëë ELITE';
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, var(--gold), var(--warning));
            color: #000;
            padding: 6px 15px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 0.8rem;
        }

        .signal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .signal-pair {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--gold);
        }

        .signal-score {
            font-family: 'Roboto Mono', monospace;
            font-size: 1.6rem;
            font-weight: 900;
            color: var(--gold);
        }

        .profit-box {
            background: rgba(255,215,0,0.15);
            border: 3px solid var(--gold);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin: 12px 0;
        }

        .profit-box .amount {
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(255,215,0,0.8);
        }

        .btn-execute {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--gold), var(--warning));
            border: none;
            border-radius: 12px;
            color: #000;
            font-weight: 900;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-execute:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px rgba(255,215,0,0.9);
        }

        .empty {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }

        @media (max-width: 1800px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üëë ULTIMATE PRO SYSTEM</h1>
            <div style="font-size: 1.3rem; color: var(--gold); margin-bottom: 15px;">
                100% R√©el ‚Ä¢ Notifications Telegram ‚Ä¢ Persistance Totale
            </div>
            
            <div class="controls">
                <button class="btn-control btn-start" id="btn-start" onclick="startSystem()">
                    üöÄ START SYSTEM
                </button>
                <button class="btn-control btn-stop" id="btn-stop" onclick="stopSystem()" disabled>
                    ‚õî STOP SYSTEM
                </button>
            </div>
            
            <div class="status-indicator stopped" id="status">
                ‚≠ï SYST√àME ARR√äT√â
            </div>
            
            <div class="features-grid">
                <div class="feature-badge">PERSISTANCE GITHUB</div>
                <div class="feature-badge">TELEGRAM LIVE</div>
                <div class="feature-badge">R√âGIME AUTO (ADX)</div>
                <div class="feature-badge">MULTI-EXCHANGE</div>
                <div class="feature-badge">ANTI-SPOOFING</div>
                <div class="feature-badge">D√âCORR√âLATION BTC</div>
                <div class="feature-badge">RANKING OPTIMAL</div>
                <div class="feature-badge">100% HALAL</div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Left Panel -->
            <div class="left-panel">
                <div class="card progress-card">
                    <h3>üëë CHALLENGE 300‚Ç¨‚Üí10K</h3>
                    <div class="capital-display">
                        <div class="value" id="capital">300‚Ç¨</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress" style="width: 3%"></div>
                    </div>
                    <div style="text-align: center; font-size: 0.9rem; color: #aaa; margin-top: 8px;" id="progress-text">3.0% ‚Ä¢ J1/30</div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="label">Signals</div>
                            <div class="value" id="sig-count">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Trades</div>
                            <div class="value" id="trades">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Win Rate</div>
                            <div class="value" id="winrate">--%</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Profit</div>
                            <div class="value" id="profit">+0‚Ç¨</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="color: var(--warning);">üéØ R√âGIME MARCH√â</h3>
                    <div style="background: rgba(255,170,0,0.1); border: 2px solid var(--warning); border-radius: 12px; padding: 15px; text-align: center; margin-bottom: 15px;">
                        <div style="font-family: 'Orbitron', sans-serif; font-size: 1.4rem; font-weight: 900; color: var(--warning); margin-bottom: 8px;" id="regime-name">INITIALIZING</div>
                        <div style="font-size: 0.85rem; color: #aaa;" id="regime-desc">Analyse...</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="label">ADX</div>
                            <div class="value" id="adx">--</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Trend</div>
                            <div class="value" id="trend">--</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="color: var(--secondary);">üì± TELEGRAM</h3>
                    <div style="background: rgba(0,212,255,0.1); border: 1px solid var(--secondary); border-radius: 10px; padding: 15px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--secondary); margin-bottom: 8px;">Status</div>
                        <div style="font-size: 0.85rem; color: #aaa;" id="telegram-info">Pr√™t</div>
                    </div>
                    <div style="background: rgba(0,212,255,0.1); border: 1px solid var(--secondary); border-radius: 10px; padding: 15px;">
                        <div style="font-weight: 700; color: var(--secondary); margin-bottom: 8px;">Notifications</div>
                        <div style="font-size: 1.5rem; font-family: 'Orbitron', sans-serif; color: var(--secondary); text-align: center;" id="notif-count">0</div>
                    </div>
                </div>
            </div>

            <!-- Center Panel -->
            <div class="center-panel">
                <div class="card console-card">
                    <h3 style="color: var(--secondary);">üì° CONSOLE</h3>
                    <div class="console" id="console">
                        <div class="log info"><span class="time">[00:00:00]</span> Syst√®me initialis√©</div>
                        <div class="log warning"><span class="time">[00:00:00]</span> Appuyez sur START pour d√©marrer</div>
                    </div>
                </div>

                <div class="card signals-card">
                    <h3>üëë SIGNALS ELITE</h3>
                    <div class="signals-grid" id="signals">
                        <div class="empty">
                            <div style="font-size: 4rem; margin-bottom: 15px;">üëë</div>
                            <div>En attente de d√©marrage...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <div class="card">
                    <h3 style="color: var(--primary);">üéØ RANKING OPTIMAL</h3>
                    <div style="background: rgba(255,215,0,0.1); border: 2px solid var(--gold); border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 8px;">Top Crypto Aujourd'hui</div>
                        <div style="font-family: 'Orbitron', sans-serif; font-size: 1.6rem; font-weight: 900; color: var(--gold);" id="top-crypto">--</div>
                    </div>
                    <div id="ranking" style="max-height: 400px; overflow-y: auto;"></div>
                </div>

                <div class="card">
                    <h3 style="color: var(--accent);">üîÆ ANOMALIES BTC</h3>
                    <div style="background: rgba(255,0,128,0.1); border: 2px solid var(--accent); border-radius: 10px; padding: 15px; text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 2rem; font-family: 'Orbitron', sans-serif; font-weight: 900; color: var(--accent);" id="anomalies-count">0</div>
                        <div style="font-size: 0.8rem; color: #aaa;">Leaders D√©tect√©s</div>
                    </div>
                    <div id="anomalies" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        const TELEGRAM_BOT_TOKEN = '8317338475:AAH4_etAd7VsUWHk_4M-HNWZtWp69pAEEpo';
        const TELEGRAM_CHAT_ID = 1719073848; // Hardcod√© depuis ton JSON

        const PAIRS = [
            'BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'XRPUSDT', 'ADAUSDT',
            'AVAXUSDT', 'DOGEUSDT', 'DOTUSDT', 'MATICUSDT', 'LINKUSDT', 'UNIUSDT',
            'ATOMUSDT', 'LTCUSDT', 'NEARUSDT', 'ALGOUSDT', 'VETUSDT', 'ICPUSDT',
            'FILUSDT', 'HBARUSDT', 'APTUSDT', 'ARBUSDT', 'OPUSDT', 'INJUSDT',
            'SUIUSDT', 'SEIUSDT', 'TAOUSDT', 'RENDERUSDT', 'TIAUSDT', 'PEPEUSDT'
        ];

        const STORAGE_KEY = 'ultimate_pro_github';

        let systemRunning = false;
        let scanInterval = null;
        let notificationsSent = 0;

        // ==========================================
        // PERSISTANCE
        // ==========================================
        
        let state = {
            capital: 300,
            day: 1,
            trades: 0,
            profit: 0,
            wins: 0,
            history: {},
            btcData: null,
            signals: [],
            regime: 'neutral',
            ranking: [],
            running: false
        };

        function saveState() {
            const data = {
                ...state,
                notificationsSent: notificationsSent,
                lastSave: Date.now()
            };
            
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                log(`‚ùå Erreur sauvegarde: ${e.message}`, 'error');
            }
        }
        
        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return;
                
                const data = JSON.parse(saved);
                
                // Restaurer l'√©tat
                state.capital = data.capital || 300;
                state.day = data.day || 1;
                state.trades = data.trades || 0;
                state.profit = data.profit || 0;
                state.wins = data.wins || 0;
                state.history = data.history || {};
                notificationsSent = data.notificationsSent || 0;
                
                // Si le syst√®me √©tait en cours d'ex√©cution, le red√©marrer
                if (data.running) {
                    log('üîÑ Restauration du syst√®me en cours...', 'warning');
                    setTimeout(() => {
                        startSystem(true); // true = restauration silencieuse
                    }, 2000);
                }
                
                log('‚úÖ √âtat restaur√©', 'success');
                log(`üí∞ Capital: ${state.capital.toFixed(2)}‚Ç¨ | Trades: ${state.trades}`, 'info');
            } catch (e) {
                log(`‚ùå Erreur chargement: ${e.message}`, 'error');
            }
        }

        function log(msg, type = 'info') {
            const con = document.getElementById('console');
            const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<span class="time">[${time}]</span> ${msg}`;
            con.appendChild(div);
            con.scrollTop = con.scrollHeight;
            if (con.children.length > 150) con.removeChild(con.firstChild);
        }

        // ==========================================
        // TELEGRAM
        // ==========================================
        
        async function sendTelegramMessage(message) {
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });

                const data = await response.json();
                
                if (data.ok) {
                    notificationsSent++;
                    document.getElementById('notif-count').textContent = notificationsSent;
                    saveState();
                    return true;
                } else {
                    log(`‚ùå Telegram: ${data.description}`, 'error');
                    return false;
                }
            } catch (e) {
                log(`‚ùå Telegram: ${e.message}`, 'error');
                return false;
            }
        }

        async function sendSignalNotification(signal) {
            const message = `
üëë **SIGNAL ELITE D√âTECT√â** üëë

üíé **${signal.symbol}** | Score: **${signal.indicators.score.toFixed(0)}%**

üìä **INDICATEURS:**
‚Ä¢ RSI: ${signal.indicators.rsi.value.toFixed(1)}
‚Ä¢ Volume: ${signal.indicators.volume.value.toFixed(0)}%
‚Ä¢ Momentum: ${signal.indicators.momentum.value > 0 ? '+' : ''}${signal.indicators.momentum.value.toFixed(2)}%

‚è±Ô∏è **DUR√âE:** ${signal.duration.best}

üí∞ **TRADING:**
‚Ä¢ Prix: $${signal.currentPrice.toFixed(4)}
‚Ä¢ Profit Estim√©: **+${signal.estimatedProfit.toFixed(2)}‚Ç¨**
‚Ä¢ Stop-Loss: -${signal.stopLoss.toFixed(2)}%

üìã **ENTR√âE PROGRESSIVE:**
1Ô∏è‚É£ Phase 1 (50%): $${signal.entryLevels.entry1.price.toFixed(4)}
2Ô∏è‚É£ Phase 2 (25%): $${signal.entryLevels.entry2.price.toFixed(4)} (+0.3%)
3Ô∏è‚É£ Phase 3 (25%): $${signal.entryLevels.entry3.price.toFixed(4)} (+0.6%)

‚ö° **BINANCE SPOT UNIQUEMENT**
`;

            return await sendTelegramMessage(message);
        }

        // ==========================================
        // CONTR√îLES START/STOP
        // ==========================================
        
        async function startSystem(silent = false) {
            if (systemRunning) return;
            
            systemRunning = true;
            state.running = true;
            saveState();
            
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-stop').disabled = false;
            document.getElementById('status').className = 'status-indicator running';
            document.getElementById('status').textContent = '‚úÖ SYST√àME EN MARCHE';
            
            if (!silent) {
                log('üöÄ Syst√®me d√©marr√©', 'success');
                await sendTelegramMessage('üöÄ **SYST√àME D√âMARR√â**\n\nLe bot est maintenant actif et scanne le march√© toutes les 60 secondes.\nVous recevrez une notification pour chaque signal Elite d√©tect√©.');
                document.getElementById('telegram-info').textContent = '‚úÖ Syst√®me actif';
            } else {
                log('üîÑ Syst√®me red√©marr√© automatiquement', 'success');
            }
            
            // Premier scan imm√©diat
            setTimeout(scan, 2000);
            
            // Scans r√©guliers
            scanInterval = setInterval(scan, 60000); // Toutes les 60 secondes
        }

        async function stopSystem() {
            if (!systemRunning) return;
            
            systemRunning = false;
            state.running = false;
            saveState();
            
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            document.getElementById('btn-start').disabled = false;
            document.getElementById('btn-stop').disabled = true;
            document.getElementById('status').className = 'status-indicator stopped';
            document.getElementById('status').textContent = '‚õî SYST√àME ARR√äT√â';
            
            log('‚õî Syst√®me arr√™t√©', 'warning');
            await sendTelegramMessage('‚õî **SYST√àME ARR√äT√â**\n\nLe bot est maintenant inactif.\nAucune nouvelle notification ne sera envoy√©e.');
            document.getElementById('telegram-info').textContent = '‚õî Syst√®me inactif';
        }

        // ==========================================
        // API & INDICATEURS
        // ==========================================
        
        async function fetchData() {
            try {
                const [priceRes, tickerRes] = await Promise.all([
                    fetch('https://api.binance.com/api/v3/ticker/price'),
                    fetch('https://api.binance.com/api/v3/ticker/24hr')
                ]);
                
                const prices = await priceRes.json();
                const tickers = await tickerRes.json();
                
                const data = {};
                PAIRS.forEach(sym => {
                    const p = prices.find(x => x.symbol === sym);
                    const t = tickers.find(x => x.symbol === sym);
                    
                    if (p && t) {
                        data[sym] = {
                            price: parseFloat(p.price),
                            volume: parseFloat(t.volume),
                            priceChange: parseFloat(t.priceChangePercent),
                            high: parseFloat(t.highPrice),
                            low: parseFloat(t.lowPrice),
                            quoteVolume: parseFloat(t.quoteVolume)
                        };
                    }
                });
                
                return data;
            } catch (e) {
                log(`‚ùå API: ${e.message}`, 'error');
                return null;
            }
        }

        function updateHistory(sym, data) {
            if (!state.history[sym]) state.history[sym] = [];
            
            state.history[sym].push({
                price: data.price,
                volume: data.volume,
                high: data.high,
                low: data.low,
                timestamp: Date.now()
            });
            
            if (state.history[sym].length > 30) state.history[sym].shift();
        }
        
        function calcRSI(sym) {
            const hist = state.history[sym];
            if (!hist || hist.length < 15) return null;
            
            let gains = 0, losses = 0;
            for (let i = hist.length - 14; i < hist.length; i++) {
                const change = hist[i].price - hist[i-1].price;
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            
            const avgGain = gains / 14;
            const avgLoss = losses / 14;
            
            if (avgLoss === 0) return 100;
            return 100 - (100 / (1 + avgGain / avgLoss));
        }
        
        function calcATR(sym) {
            const hist = state.history[sym];
            if (!hist || hist.length < 15) return null;
            
            let sum = 0;
            for (let i = hist.length - 14; i < hist.length; i++) {
                const tr = Math.max(
                    hist[i].high - hist[i].low,
                    Math.abs(hist[i].high - hist[i-1].price),
                    Math.abs(hist[i].low - hist[i-1].price)
                );
                sum += tr;
            }
            
            return sum / 14;
        }
        
        function calcADX(sym) {
            const hist = state.history[sym];
            if (!hist || hist.length < 15) return null;
            
            let sumDX = 0;
            for (let i = hist.length - 14; i < hist.length; i++) {
                const high = hist[i].high;
                const low = hist[i].low;
                const prevClose = hist[i-1].price;
                
                const tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
                const upMove = high - hist[i-1].high;
                const downMove = hist[i-1].low - low;
                
                const plusDM = upMove > downMove && upMove > 0 ? upMove : 0;
                const minusDM = downMove > upMove && downMove > 0 ? downMove : 0;
                
                if (tr > 0) {
                    const plusDI = (plusDM / tr) * 100;
                    const minusDI = (minusDM / tr) * 100;
                    const dx = Math.abs(plusDI - minusDI) / (plusDI + minusDI) * 100;
                    sumDX += dx;
                }
            }
            
            return sumDX / 14;
        }
        
        function calcMomentum(sym) {
            const hist = state.history[sym];
            if (!hist || hist.length < 10) return null;
            
            const now = hist[hist.length - 1].price;
            const prev = hist[hist.length - 10].price;
            return ((now - prev) / prev) * 100;
        }
        
        function calcVolumeTrend(sym, currentVol) {
            const hist = state.history[sym];
            if (!hist || hist.length < 10) return null;
            
            const avgVol = hist.reduce((sum, h) => sum + h.volume, 0) / hist.length;
            return (currentVol / avgVol) * 100;
        }
        
        function detectRegime() {
            if (!state.btcData) return 'neutral';
            
            const adx = calcADX('BTCUSDT');
            const atr = calcATR('BTCUSDT');
            const momentum = calcMomentum('BTCUSDT');
            
            if (!adx || !atr || !momentum) return 'neutral';
            
            const volatilityPct = (atr / state.btcData.price) * 100;
            
            if (adx > 25 && momentum > 2) return 'strong_bull';
            else if (adx > 25 && momentum < -2) return 'strong_bear';
            else if (volatilityPct > 3) return 'high_volatility';
            else if (adx < 20 && Math.abs(momentum) < 1) return 'ranging';
            
            return 'neutral';
        }
        
        function calcDecorrelation(sym) {
            if (sym === 'BTCUSDT') return 0;
            
            const btcMom = calcMomentum('BTCUSDT');
            const symMom = calcMomentum(sym);
            
            if (!btcMom || !symMom) return null;
            
            if (Math.abs(btcMom) > 1 && Math.abs(symMom) < 0.5) {
                return Math.abs(btcMom - symMom);
            }
            
            return 0;
        }
        
        function estimateDuration(sym) {
            const momentum = calcMomentum(sym);
            const hist = state.history[sym];
            
            if (!momentum || !hist || hist.length < 10) return null;
            
            const velocity = Math.abs(momentum);
            const acceleration = hist.length >= 15 ? 
                Math.abs(hist[hist.length-1].price - hist[hist.length-5].price) / hist[hist.length-5].price * 100 : 0;
            
            const score5min = (acceleration > 0.3 && velocity > 0.5) ? 85 : 40;
            const score15min = (velocity > 1) ? 80 : 45;
            const score30min = (velocity > 0.5) ? 75 : 35;
            const score60min = (velocity > 0.3) ? 70 : 30;
            
            return {
                '5min': score5min,
                '15min': score15min,
                '30min': score30min,
                '60min': score60min,
                best: score5min > score15min ? '5-10min' : score15min > score30min ? '15-20min' : '30min+'
            };
        }
        
        function checkSpoofing(data) {
            const volumeRatio = data.quoteVolume / (data.price * data.volume);
            if (volumeRatio < 0.8) return { safe: false, reason: 'Volume suspect' };
            
            if (data.quoteVolume < 10000000) return { safe: false, reason: 'Liquidit√© faible' };
            
            const volatility = ((data.high - data.low) / data.price) * 100;
            if (volatility > 10) return { safe: false, reason: 'Volatilit√© extr√™me' };
            
            return { safe: true, reason: 'Volume r√©el ‚úì' };
        }
        
        function calcOptimalScore(sym, data) {
            if (!state.btcData) return 0;
            
            const atr = calcATR(sym);
            const momentum = calcMomentum(sym);
            const btcMom = calcMomentum('BTCUSDT');
            
            if (!atr || !momentum || !btcMom) return 0;
            
            const volatilityPct = (atr / data.price) * 100;
            const volatilityScore = volatilityPct >= 0.8 && volatilityPct <= 2.5 ? 30 : 
                                   volatilityPct >= 0.5 && volatilityPct <= 3 ? 20 : 10;
            
            const volumeScore = data.quoteVolume > 100000000 ? 30 : 
                               data.quoteVolume > 50000000 ? 20 : 10;
            
            const decorrelation = Math.abs(momentum - btcMom);
            const decorrScore = decorrelation > 3 ? 40 : decorrelation > 2 ? 30 : decorrelation > 1 ? 20 : 10;
            
            return volatilityScore + volumeScore + decorrScore;
        }
        
        function calcConvergence(sym, data) {
            const rsi = calcRSI(sym);
            const atr = calcATR(sym);
            const adx = calcADX(sym);
            const volTrend = calcVolumeTrend(sym, data.volume);
            const momentum = calcMomentum(sym);
            const decorrelation = calcDecorrelation(sym);
            
            if (!rsi || !atr || !adx || !volTrend || !momentum) return null;
            
            const volatilityPct = (atr / data.price) * 100;
            if (volatilityPct < 0.3 || volatilityPct > 5) return null;
            
            const spoofCheck = checkSpoofing(data);
            if (!spoofCheck.safe) return null;
            
            let rsiSignal = 0;
            if (rsi < 30) rsiSignal = 1;
            else if (rsi > 40 && rsi < 60 && momentum > 0) rsiSignal = 0.7;
            
            let volumeSignal = volTrend > 150 ? 1 : 0;
            let momentumSignal = momentum > 0.5 ? 1 : 0;
            let adxSignal = adx > 20 ? 1 : 0;
            let decorrelationSignal = decorrelation && decorrelation > 2 ? 1 : 0;
            
            let weights = { rsi: 0.2, volume: 0.2, momentum: 0.2, adx: 0.2, decorrelation: 0.2 };
            
            if (state.regime === 'strong_bull' || state.regime === 'strong_bear') {
                weights = { rsi: 0.15, volume: 0.25, momentum: 0.35, adx: 0.15, decorrelation: 0.1 };
            } else if (state.regime === 'ranging') {
                weights = { rsi: 0.35, volume: 0.35, momentum: 0.1, adx: 0.1, decorrelation: 0.1 };
            }
            
            const score = (rsiSignal * weights.rsi + volumeSignal * weights.volume + 
                          momentumSignal * weights.momentum + adxSignal * weights.adx +
                          decorrelationSignal * weights.decorrelation) * 100;
            
            const convergent = score >= 70 && volumeSignal === 1;
            
            return {
                rsi: { value: rsi },
                volume: { value: volTrend },
                momentum: { value: momentum },
                adx: { value: adx },
                volatility: { value: volatilityPct },
                decorrelation: decorrelation || 0,
                score: score,
                convergent: convergent,
                spoofCheck: spoofCheck
            };
        }

        function calcEntryLevels(currentPrice) {
            return {
                entry1: { pct: 50, price: currentPrice },
                entry2: { pct: 25, price: currentPrice * (1 + 0.003) },
                entry3: { pct: 25, price: currentPrice * (1 + 0.006) }
            };
        }

        // ==========================================
        // SCAN
        // ==========================================
        
        async function scan() {
            if (!systemRunning) return;
            
            log('üîç Scanning...', 'info');
            
            const data = await fetchData();
            if (!data || !data['BTCUSDT']) return;
            
            state.btcData = data['BTCUSDT'];
            updateHistory('BTCUSDT', state.btcData);
            
            // R√©gime
            state.regime = detectRegime();
            const regimeNames = {
                strong_bull: 'TENDANCE HAUSSI√àRE',
                strong_bear: 'TENDANCE BAISSI√àRE',
                ranging: 'RANGE',
                high_volatility: 'VOLATILIT√â EXTR√äME',
                neutral: 'NEUTRE'
            };
            const regimeDescs = {
                strong_bull: 'Momentum fort',
                strong_bear: 'Baisse marqu√©e',
                ranging: 'Consolidation',
                high_volatility: 'News/Events',
                neutral: '√âquilibr√©'
            };
            document.getElementById('regime-name').textContent = regimeNames[state.regime];
            document.getElementById('regime-desc').textContent = regimeDescs[state.regime];
            
            const adx = calcADX('BTCUSDT');
            const momentum = calcMomentum('BTCUSDT');
            document.getElementById('adx').textContent = adx ? adx.toFixed(1) : '--';
            document.getElementById('trend').textContent = momentum && momentum > 0 ? 'BULL' : 'BEAR';
            
            // Ranking
            state.ranking = [];
            const anomalies = [];
            
            for (const sym of PAIRS) {
                if (!data[sym]) continue;
                updateHistory(sym, data[sym]);
                
                const score = calcOptimalScore(sym, data[sym]);
                state.ranking.push({
                    symbol: sym.replace('USDT', ''),
                    score: score,
                    volatility: data[sym].priceChange,
                    volume: data[sym].quoteVolume / 1000000,
                    momentum: calcMomentum(sym) || 0
                });
                
                const decorr = calcDecorrelation(sym);
                if (decorr && decorr > 2) {
                    anomalies.push({
                        symbol: sym.replace('USDT', ''),
                        decorrelation: decorr
                    });
                }
            }
            
            state.ranking.sort((a, b) => b.score - a.score);
            if (state.ranking.length > 0) {
                document.getElementById('top-crypto').textContent = state.ranking[0].symbol;
            }
            
            document.getElementById('anomalies-count').textContent = anomalies.length;
            renderRanking();
            renderAnomalies(anomalies);
            
            // Scan signals (top 5)
            state.signals = [];
            const topPairs = state.ranking.slice(0, 5).map(r => r.symbol + 'USDT');
            
            for (const sym of topPairs) {
                if (!data[sym]) continue;
                
                const conv = calcConvergence(sym, data[sym]);
                if (!conv || !conv.convergent) continue;
                
                const duration = estimateDuration(sym);
                if (!duration) continue;
                
                const atr = calcATR(sym);
                const stopLossPct = (atr / data[sym].price) * 100 * 2;
                const riskAmount = state.capital * 0.005;
                const positionSize = Math.min(riskAmount / (stopLossPct / 100), state.capital);
                
                const targetProfit = conv.momentum.value * 0.6;
                const entryLevels = calcEntryLevels(data[sym].price);
                
                const avgProfit = (
                    (positionSize * 0.5 * targetProfit / 100) +
                    (positionSize * 0.25 * (targetProfit + 0.3) / 100) +
                    (positionSize * 0.25 * (targetProfit + 0.6) / 100)
                );
                
                const fees = positionSize * 0.003 * 3;
                const netProfit = avgProfit - fees;
                
                if (netProfit > 0) {
                    const signal = {
                        symbol: sym.replace('USDT', ''),
                        fullSym: sym,
                        indicators: conv,
                        duration: duration,
                        currentPrice: data[sym].price,
                        estimatedProfit: netProfit,
                        stopLoss: stopLossPct,
                        targetProfit: targetProfit,
                        positionSize: positionSize,
                        entryLevels: entryLevels,
                        isElite: conv.score >= 85
                    };
                    
                    state.signals.push(signal);
                    
                    log(`üëë SIGNAL: ${sym} Score:${conv.score.toFixed(0)}%`, 'success');
                    
                    // NOTIFICATION TELEGRAM
                    await sendSignalNotification(signal);
                }
            }
            
            document.getElementById('sig-count').textContent = state.signals.length;
            render();
            saveState();
            
            log(`‚úÖ Scan termin√©: ${state.signals.length} signals`, 'success');
        }

        function renderRanking() {
            const con = document.getElementById('ranking');
            con.innerHTML = '';
            
            state.ranking.slice(0, 10).forEach((item, i) => {
                const div = document.createElement('div');
                div.style.cssText = 'background: rgba(0,255,136,0.05); border: 2px solid var(--border); border-radius: 10px; padding: 12px; margin-bottom: 10px;';
                if (i < 3) div.style.cssText += 'border-color: var(--gold); background: rgba(255,215,0,0.1);';
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <div style="font-weight: 900; font-size: 1.2rem;">#${i + 1} ${item.symbol}</div>
                        <div style="font-family: 'Roboto Mono', monospace; font-weight: 900; color: ${i < 3 ? 'var(--gold)' : 'var(--primary)'};">${item.score}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #aaa;">
                        <div>Vol: ${item.volume.toFixed(0)}M</div>
                        <div>Mom: ${item.momentum > 0 ? '+' : ''}${item.momentum.toFixed(2)}%</div>
                    </div>
                `;
                
                con.appendChild(div);
            });
        }

        function renderAnomalies(anomalies) {
            const con = document.getElementById('anomalies');
            con.innerHTML = '';
            
            if (anomalies.length === 0) {
                con.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-size: 0.8rem;">Aucune anomalie</div>';
                return;
            }
            
            anomalies.sort((a, b) => b.decorrelation - a.decorrelation).slice(0, 5).forEach(anom => {
                const div = document.createElement('div');
                div.style.cssText = 'background: rgba(255,0,128,0.05); border: 1px solid var(--accent); border-radius: 8px; padding: 10px; margin-bottom: 8px;';
                div.innerHTML = `
                    <div style="font-weight: 700; margin-bottom: 4px;">${anom.symbol}</div>
                    <div style="font-size: 0.75rem; color: #aaa;">D√©corr√©lation: ${anom.decorrelation.toFixed(1)}</div>
                `;
                con.appendChild(div);
            });
        }

        function render() {
            const con = document.getElementById('signals');
            
            if (state.signals.length === 0) {
                con.innerHTML = '<div class="empty"><div style="font-size: 4rem; margin-bottom: 15px;">‚è≥</div><div>En attente de signal...</div></div>';
                return;
            }
            
            con.innerHTML = '';
            state.signals.forEach((sig, i) => {
                const card = document.createElement('div');
                card.className = `signal-card ${sig.isElite ? 'elite' : ''}`;
                
                card.innerHTML = `
                    <div class="signal-header">
                        <div class="signal-pair">${sig.symbol}</div>
                        <div class="signal-score">${sig.indicators.score.toFixed(0)}%</div>
                    </div>
                    
                    <div style="background: rgba(255,0,128,0.1); border: 2px solid var(--accent); border-radius: 10px; padding: 12px; margin-bottom: 12px; text-align: center;">
                        <div style="font-size: 0.8rem; color: var(--accent); font-weight: 700; margin-bottom: 8px;">‚è±Ô∏è DUR√âE ESTIM√âE</div>
                        <div style="font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 900; color: var(--accent);">${sig.duration.best}</div>
                    </div>
                    
                    <div class="profit-box">
                        <div style="font-size: 0.8rem; color: #888; margin-bottom: 6px;">Profit (+${sig.targetProfit.toFixed(1)}%)</div>
                        <div class="amount">+${sig.estimatedProfit.toFixed(2)}‚Ç¨</div>
                    </div>
                    
                    <div style="text-align: center; font-size: 0.85rem; color: #aaa; margin-bottom: 12px;">
                        üì± Notification Telegram envoy√©e !
                    </div>
                    
                    <button class="btn-execute" onclick="execute(${i})">
                        ‚úÖ MARQUER EX√âCUT√â
                    </button>
                `;
                
                con.appendChild(card);
            });
        }

        function execute(i) {
            const sig = state.signals[i];
            const profit = sig.estimatedProfit;
            
            state.capital += profit;
            state.trades++;
            state.profit += profit;
            state.wins++;
            
            log(`‚úÖ ${sig.symbol} +${profit.toFixed(2)}‚Ç¨`, 'success');
            
            updateUI();
            saveState();
            
            state.signals.splice(i, 1);
            render();
        }

        function updateUI() {
            const prog = (state.capital / 10000) * 100;
            document.getElementById('progress').style.width = `${prog}%`;
            document.getElementById('progress-text').textContent = `${prog.toFixed(1)}% ‚Ä¢ J${state.day}/30`;
            document.getElementById('capital').textContent = `${state.capital.toFixed(0)}‚Ç¨`;
            document.getElementById('trades').textContent = state.trades;
            document.getElementById('profit').textContent = `+${state.profit.toFixed(0)}‚Ç¨`;
            
            if (state.trades > 0) {
                const wr = (state.wins / state.trades) * 100;
                document.getElementById('winrate').textContent = `${wr.toFixed(0)}%`;
            }
        }

        // ==========================================
        // AUTO SAVE & INIT
        // ==========================================
        
        setInterval(saveState, 30000); // Sauvegarde automatique toutes les 30s
        window.addEventListener('beforeunload', saveState);

        log('üëë ULTIMATE PRO System Initialized', 'success');
        log('üíæ Persistance GitHub activ√©e', 'success');
        log('üì± Telegram Chat ID: ' + TELEGRAM_CHAT_ID, 'telegram');
        log('‚ö° Appuyez sur START pour d√©marrer', 'warning');
        
        updateUI();
        document.getElementById('notif-count').textContent = notificationsSent;
        
        // Charger l'√©tat sauvegard√© au d√©marrage
        loadState();
    </script>
</body>
</html>
